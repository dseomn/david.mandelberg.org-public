{#
 # SPDX-FileCopyrightText: 2025 David Mandelberg <david@mandelberg.org>
 #
 # SPDX-License-Identifier: Apache-2.0
 #}

{% set metadata = ginjarator.py.import_("dseomn_website.metadata") %}
{% set paths = ginjarator.py.import_("dseomn_website.paths") %}

{% call ginjarator.fs.write_text_macro(paths.OUTPUT / ".htaccess") %}
Options FollowSymlinks

RewriteEngine on
RewriteBase /

# See https://stackoverflow.com/a/24258932/16979806 for REDIRECT_STATUS.
RewriteCond "%{IS_SUBREQ}" "^true$" [ornext]
RewriteCond "%{ENV:REDIRECT_STATUS}" "!^$"
RewriteRule "" "-" [env=is_internal_request:1]

DirectoryIndex disabled
DirectoryIndex {{ paths.DIR_INDEXES | join(" ") }}
RewriteCond "%{ENV:is_internal_request}" "^$"
RewriteCond "%{REQUEST_FILENAME}" "-f"
RewriteRule \
  "^((?:.*/)?)index(?:\.[^/]*)?$" \
  "$1" \
  [last,redirect=permanent]

{%- for post in metadata.Post.all() %}
{%- for url_path_alias in post.url_path_aliases %}
Redirect permanent "{{ url_path_alias }}" "{{ post.url_path }}"
{%- endfor %}
{%- endfor %}

AddType application/atom+xml .atom
AddType font/woff2 .woff2
AddType image/jpeg .jpg
AddType image/png .png
AddType text/css .css
AddType text/html .html
AddType text/plain .txt
AddCharset utf-8 .css .html .txt

{% for error_metadata in metadata.Error.all() %}
ErrorDocument {{ error_metadata.status.value }} {{ error_metadata.url_path }}
{% endfor %}
{% endcall %}
