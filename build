#!/bin/bash

# SPDX-FileCopyrightText: 2025 David Mandelberg <david@mandelberg.org>
#
# SPDX-License-Identifier: Apache-2.0

set -euxo pipefail

reuse lint

black --check --diff .
isort --check --diff .
mypy
# Explicitly ignore output_test to save time collecting its tests.
pytest \
  -m 'not output and not slow' \
  --ignore=src/dseomn_website/output_test.py \
  src

ninja
# TODO: https://github.com/ninja-build/ninja/issues/905 - Remove this hack.
if [[ "$(ninja -n)" != 'ninja: no work to do.' ]]; then
  echo 'ERROR: Running ninja a second time is not a no-op.'
  exit 1
fi
ninja -t cleandead
# TODO: https://github.com/ninja-build/ninja/issues/2617 - Delete this.
find output work -depth -type d -empty -print -delete

# TODO: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=849473 - Validate
# html.
pytest -m 'output and not slow' --no-cov src
