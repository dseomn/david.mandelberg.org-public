{#
 # SPDX-FileCopyrightText: 2025 David Mandelberg <david@mandelberg.org>
 #
 # SPDX-License-Identifier: Apache-2.0
 #}

{% set media = ginjarator.py.import_("dseomn_website.media") %}

{% import "include/base_html.html.jinja" as base_html %}

{% macro image(image_metadata, profile_name, id=none) -%}
  {%- set profile = media.IMAGE_PROFILES[profile_name] -%}
  {%- set primary_output = profile.primary_output(image_metadata.source) -%}
  {%- set outputs = profile.unique_outputs(image_metadata.source) -%}
  <img
      {% if id is not none %}
        id="{{ id | e }}"
      {% endif %}
      sizes="{{ profile.responsive_sizes() | e }}"
      {% if none not in (primary_output.url_path, primary_output.metadata) %}
        src="{{ primary_output.url_path | e }}"
        height="{{ primary_output.metadata.geometry.height | e }}"
        width="{{ primary_output.metadata.geometry.width | e }}"
      {% endif %}
      srcset="
        {%- set srcset_joiner = joiner(", ") -%}
        {%- for output in outputs if none not in (
          output.url_path,
          output.metadata,
        ) -%}
          {{- srcset_joiner() -}}
          {{ output.url_path | e }} {{ output.metadata.geometry.width | e }}w
        {%- endfor -%}
      "
      class="image-{{ profile_name.replace("_", "-") | e }}"
      loading="lazy"
      alt="{{ image_metadata.alt | e }}"
      >
{%- endmacro %}

{% macro gallery(page_metadata, gallery_name) %}
  <div class="gallery">
    {% for media_item in page_metadata.media.item_by_source.values()
      if media_item.gallery == gallery_name
    %}
      {% set media_item_details_metadata = (
        page_metadata.media_item_details_by_source[media_item.source]
      ) %}
      {% set media_item_details_fragment = media_item_details_metadata.fragment(
        media_item.source.name
      ) %}
      {% if media_item.type_ == "image" %}
        {% call base_html.write(
          page_metadata=media_item_details_metadata,
        ) %}
          <section class="media-item-details">
            <header class="media-item-details-header">
              <h1 class="h1">{{ media_item_details_metadata.title | e }}</h1>
            </header>
            {{ image(
              media_item,
              "full_screen",
              id=media_item_details_fragment.id,
            ) }}
            <div class="media-item-details-text">
              {% if media_item.description_template is not none %}
                {#
                 # TODO: https://github.com/pallets/jinja/issues/2108 - Add
                 # `without context`
                 #}
                {% include (media_item.description_template | string) %}
              {% endif %}
            </div>
          </section>
        {% endcall %}
        <a href="{{ media_item_details_fragment.url_path | e }}">
          {{ image(media_item, "gallery_thumbnail") }}
        </a>
      {% else %}
        {% do ginjarator.py.assert_(false) %}
      {% endif %}
    {% endfor %}
  </div>
{% endmacro %}
