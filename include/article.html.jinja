{#
 # SPDX-FileCopyrightText: 2025 David Mandelberg <david@mandelberg.org>
 #
 # SPDX-License-Identifier: Apache-2.0
 #}

{% set headings = ginjarator.py.import_("dseomn_website.headings") %}
{% set metadata = ginjarator.py.import_("dseomn_website.metadata") %}

{% import "include/base_html.html.jinja" as base_html %}

{% macro standalone(
  url_path,
  title,
  extra_head=""
) %}
  {% set fragment %}
    <article class="article">
      <h1>{{ title | e }}</h1>
      {{ caller() }}
    </article>
  {% endset %}
  {% call base_html.write(
    url_path=url_path,
    title=title,
    extra_head=extra_head,
  ) %}
    {{ headings.article(fragment) }}
  {% endcall %}
{% endmacro %}

{% macro _post_fragment(
  id,
  post_metadata,
  link,
  contents
) %}
  <article class="article" id="{{ id | e }}">
    <header class="article-header">
      <h1 class="article-header-title">
        {% if link is none %}
          {{ post_metadata.title | e }}
        {% else %}
          <a rel="bookmark" href="{{ link | e }}">
            {{ post_metadata.title | e }}
          </a>
        {% endif %}
      </h1>
      <dl class="article-header-metadata">
        <div class="article-header-metadata-item">
          <dt class="article-header-metadata-key">
            <span aria-label="date" role="img">üìÖ</span>
          </dt>
          <dd
              class="article-header-metadata-value
                     article-header-metadata-numeric"
              >
            <time>
              {{
                post_metadata.published.isoformat(sep=" ", timespec="seconds") |
                e
              }}
            </time>
          </dd>
        </div>
        <div class="article-header-metadata-item">
          <dt class="article-header-metadata-key">
            <span aria-label="author" role="img">üë§</span>
          </dt>
          <dd  class="article-header-metadata-value">
            {{ post_metadata.author | e }}
          </dd>
        </div>
        {% if post_metadata.tags %}
          <div class="article-header-metadata-item">
            <dt class="article-header-metadata-key">
              <span aria-label="tags" role="img">üè∑Ô∏è</span>
            </dt>
            <dd class="article-header-metadata-value">
              {% set tag_joiner = joiner(", ") %}
              {% for tag in post_metadata.tags -%}
                {{- tag_joiner() -}}
                <a href="/tag/{{ tag | e }}/" rel="tag">{{ tag | e }}</a>
              {%- endfor %}
            </dd>
          </div>
        {% endif %}
      </dl>
    </header>
    {{ contents }}
  </article>
{% endmacro %}

{% macro post() %}
  {% set post_metadata = metadata.Post.load(ginjarator.current_template) %}
  {% set source_dir_name = ginjarator.current_template.parent.name %}
  {% set source_dir_date_prefix = post_metadata.published.strftime(
    "%Y-%m-%d-"
  ) %}
  {% do ginjarator.py.assert_(
    source_dir_name.startswith(source_dir_date_prefix)
  ) %}
  {% set slug = source_dir_name.removeprefix(source_dir_date_prefix) %}
  {% set url_path = (
    post_metadata.published.strftime("/%Y/%m/%d/") + slug + "/"
  ) %}
  {% set work_path = "work/posts/" + source_dir_name %}
  {% set extra_head %}
    <meta
        property="article:published_time"
        content="{{ post_metadata.published.isoformat() | e }}"
        >
    {% for tag in post_metadata.tags %}
      <meta property="article:tag" content="{{ tag | e }}">
    {% endfor %}
    <meta property="og:type" content="article">
  {% endset %}
  {% set contents = caller() %}
  {% call base_html.write(
    url_path=url_path,
    title=post_metadata.title,
    extra_head=extra_head,
  ) %}
    {{ headings.article(
      _post_fragment(
        id=source_dir_name,
        post_metadata=post_metadata,
        link=none,
        contents=contents,
      ),
    ) }}
  {% endcall %}
  {% do ginjarator.fs.write_text(
    work_path + "/include-fragment.html",
    headings.article(
      _post_fragment(
        id=source_dir_name,
        post_metadata=post_metadata,
        link=url_path,
        contents=contents,
      ),
      offset=1,
    ),
  ) %}
  {% call ginjarator.fs.write_text_macro(work_path + "/atom-fragment.xml") %}
    <entry>
      <author><name>{{ post_metadata.author | e }}</name></author>
      {% for tag in post_metadata.tags %}
        <category term="{{ tag | e }}"/>
      {% endfor %}
      <content type="html">
        {{- base_html.minify(contents) | e -}}
      </content>
      <id>urn:uuid:{{ post_metadata.uuid | e }}</id>
      <link href="{{ url_path | e }}" rel="alternate"/>
      <published>{{ post_metadata.published.isoformat() | e }}</published>
      <title>{{ post_metadata.title | e }}</title>
      <updated>{{ post_metadata.published.isoformat() | e }}</updated>
    </entry>
  {% endcall %}
{% endmacro %}
