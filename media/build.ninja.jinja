{#
 # SPDX-FileCopyrightText: 2025 David Mandelberg <david@mandelberg.org>
 #
 # SPDX-License-Identifier: Apache-2.0
 #}

{% set media = ginjarator.py.import_("dseomn_website.media") %}

{% import "include/cache_buster.ninja.jinja" as cache_buster %}

{{ cache_buster.rules }}

rule image_convert
  command = in=$in; out=$out; $conversion_command
  description = CONVERT $in ($conversion)

rule image_metadata
  command = magick -define json:version=1.0 $in $out
  description = METADATA $in

{% for image_output in media.all_image_outputs() %}
build $
    {{ ginjarator.to_ninja(image_output.work_path) }} $
    : $
    image_convert $
    {{ ginjarator.to_ninja(image_output.source) }}
  conversion = {{ ginjarator.to_ninja(image_output.conversion.suffix) }}
  conversion_command = $
    {{ ginjarator.to_ninja(image_output.conversion.sh_command) }}
build $
    {{ ginjarator.to_ninja(image_output.metadata_path) }} $
    : $
    image_metadata $
    {{ ginjarator.to_ninja(image_output.work_path) }}
{{ cache_buster.build(
  input_dir=image_output.work_path.parent | string,
  input_filenames=(image_output.work_path.name,),
  work_dir=image_output.work_path.parent | string,
  work_filename_base=image_output.work_path.name,
) }}
{% endfor %}
