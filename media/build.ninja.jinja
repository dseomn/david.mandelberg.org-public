{#
 # SPDX-FileCopyrightText: 2025 David Mandelberg <david@mandelberg.org>
 #
 # SPDX-License-Identifier: Apache-2.0
 #}

{% set media = ginjarator.py.import_("dseomn_website.media") %}

{% import "include/cache_buster.ninja.jinja" as cache_buster %}

{{ cache_buster.rules }}

rule image_convert
  command = magick $in $args $out
  description = CONVERT $in ($conversion)

rule image_metadata
  command = magick -define json:version=1.0 $in json:- | jq '.[0].image' > $out
  description = METADATA $in

{% for output_config in media.all_image_output_configs() %}
build $
    {{ ginjarator.to_ninja(output_config.work_path) }} $
    : $
    image_convert $
    {{ ginjarator.to_ninja(output_config.source) }}
  args = {{ ginjarator.to_ninja(
    output_config.conversion.magick_args,
    escape_shell=true,
  ) }}
  conversion = {{ ginjarator.to_ninja(output_config.conversion.suffix) }}
build $
    {{ ginjarator.to_ninja(output_config.metadata_path) }} $
    : $
    image_metadata $
    {{ ginjarator.to_ninja(output_config.work_path) }}
{{ cache_buster.build(
  to_hash=output_config.work_path,
  work_prefix=output_config.cache_buster_path,
  prefix=output_config.cache_buster_prefix,
  suffix=output_config.cache_buster_suffix,
) }}
{% endfor %}
